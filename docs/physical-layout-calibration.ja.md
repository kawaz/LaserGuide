# 物理レイアウトキャリブレーション

## 概要

LaserGuideは、マルチディスプレイ環境を正確に扱うために**物理レイアウトキャリブレーション**システムを使用しています。自動的なPPIベースの補正に頼るのではなく、ユーザーが実際の物理的なディスプレイ配置を手動で設定します。

## なぜ物理キャリブレーションなのか？

### 自動PPI補正の問題点

当初、LaserGuideは異なるPPI（Pixels Per Inch）のディスプレイ間で自動的に補正を試みていました。しかし、このアプローチにはいくつかの根本的な限界がありました：

**1. 不正確な座標変換**
- 異なるPPIディスプレイ間での自動スケーリングは丸め誤差を生じる
- レーザーラインがカーソル位置を正確に指さない
- 距離が離れるほど誤差が蓄積

**2. 完璧な整列の仮定**
- PPI補正は、ディスプレイが完全に水平または垂直に整列していることを前提としている
- 実際のセットアップでは以下のようなケースが多い：
  - 回転されたディスプレイ（ポートレートモード）
  - 角度のついたディスプレイ（人間工学的な配置）
  - 水平オフセットのある垂直積み重ね
  - 複雑な配置（L字型、コの字型など）

**3. 柔軟性の欠如**
- ベゼルやモニタ間のギャップを考慮する方法がない
- 特殊な構成に対応できない
- 精度に対するユーザーコントロールがない

### 物理キャリブレーションのメリット

**1. ユーザー制御による正確性**
- ユーザーが実際の物理的な配置通りにディスプレイを配置
- 論理座標（macOS）から物理位置への直接マッピング
- 自動推測なしの完璧な精度

**2. 柔軟な構成**
- あらゆるディスプレイ配置をサポート
- 回転、オフセット、ギャップに対応
- 混在したディスプレイサイズと向きに対応

**3. 構成ごとの永続化**
- ディスプレイの組み合わせごとにキャリブレーションを保存（ハードウェアIDで識別）
- ディスプレイ構成が変更されたときの自動検出
- 各セットアップ（自宅、オフィスなど）が独自のキャリブレーションを持つ

**4. オプションかつフォールバック**
- キャリブレーションはオプション - LaserGuideはデフォルトで論理座標で動作
- キャリブレーションが存在する場合、精度向上のために使用
- キャリブレーションがない場合は論理座標にフォールバック

## 仕組み

### ディスプレイの識別

各ディスプレイは、そのハードウェア特性によって識別されます：
- ベンダーID
- モデルID
- シリアル番号

これにより、以下の場合でもキャリブレーションデータが正しく維持されます：
- ディスプレイの接続順序が変わった場合
- スリープ/ウェイク後にDisplayID番号が変わった場合
- ディスプレイが切断され再接続された場合

### キャリブレーションデータ構造

```swift
struct PhysicalDisplayLayout: Codable {
    let identifier: DisplayIdentifier     // ハードウェアベースのID
    let position: PhysicalPoint           // 左下隅（mm）
    let size: PhysicalSize                // 幅と高さ（mm）
}

struct DisplayConfiguration: Codable {
    let displays: [PhysicalDisplayLayout]
    let timestamp: Date
    var configurationKey: String          // このディスプレイ組み合わせのユニークキー
}
```

すべての物理測定値は、一貫性と精度のためにミリメートル単位です。

### 構成キーの形式

```
config_vendorID-modelID-serial_vendorID-modelID-serial_...
```

例：
```
config_1552-16385-0_1452-42086-0
```

識別子はソートされており、ディスプレイの接続順序に関係なく同じキーが生成されます。

## キャリブレーションUI

### キャリブレーションツールを開く

メニューバーからアクセス：**LaserGuide** > **Calibrate Physical Layout...**

### キャリブレーションウィンドウ

**左側：論理座標（macOS）**
- macOSがディスプレイをどう認識しているかを表示
- 読み取り専用の可視化
- システム設定 > ディスプレイの配置に基づく
- 「Open Display Settings...」をクリックして論理レイアウトを変更

**右側：物理レイアウト（ドラッグ可能）**
- 実際の物理位置を表現
- 初期状態では論理レイアウトと一致
- 実際の机の上の配置に合わせてディスプレイをドラッグ
- 衝突検出により重なりを防止
- キャンバスに収まるように自動的に再スケーリング

### キャリブレーション手順

1. **初期状態**：物理レイアウトは論理レイアウトと一致
2. **物理位置の調整**：右側のディスプレイをドラッグして実際の配置に合わせる
   - 実際のベゼル幅を考慮
   - 物理的なギャップやオフセットを考慮
   - 机の上の高さの違いを一致させる
3. **視覚的フィードバック**：ドラッグ中に座標ラベルがリアルタイムで更新
4. **保存**：「Save Calibration」をクリックして設定を保存
5. **リセット**：「Reset to Default」で物理レイアウトを論理配置に戻す

### ウィンドウ機能

- **リサイズ可能**：ウィンドウの端をドラッグしてワークスペースを拡大
- **分割調整可能**：中央の仕切りをドラッグして左右パネルをリサイズ
- **スケール情報**：現在のディスプレイスケール比率を表示（例：「1:2 = 1px = 2mm」）
- **構成表示**：現在の構成キーを表示
- **ステータスインジケータ**：保存された構成が存在する場合に「✓ Calibration saved」を表示

## CalibrationDataManager

### 役割

キャリブレーションデータの永続化と取得のための一元管理マネージャー。

### 主要メソッド

```swift
class CalibrationDataManager {
    static let shared = CalibrationDataManager()

    // 現在のディスプレイ構成を取得
    func getCurrentDisplayConfiguration() -> (
        logical: [LogicalDisplayInfo],
        physical: [ScreenInfo]
    )

    // 現在のセットアップの構成キーを生成
    func getCurrentConfigurationKey() -> String

    // キャリブレーションデータを保存
    func saveCalibration(_ configuration: DisplayConfiguration)

    // 現在の構成のキャリブレーションデータをロード
    func loadCalibration() -> DisplayConfiguration?

    // キャリブレーションが存在するか確認
    func hasCalibration() -> Bool

    // 現在の構成のキャリブレーションを削除
    func deleteCalibration()

    // 保存されているすべての構成をリスト
    func listAllCalibrations() -> [String]
}
```

### ストレージ

キャリブレーションデータは`UserDefaults`に以下のキーで保存されます：
```
LaserGuide.Calibration.config_<configuration-key>
```

### 使用例

```swift
let manager = CalibrationDataManager.shared

// 現在のセットアップにキャリブレーションがあるか確認
if manager.hasCalibration() {
    if let config = manager.loadCalibration() {
        // configから物理位置を使用
        for layout in config.displays {
            print("\(layout.identifier): (\(layout.position.x), \(layout.position.y))")
        }
    }
} else {
    // 論理座標にフォールバック
    let (logical, _) = manager.getCurrentDisplayConfiguration()
    for display in logical {
        print("\(display.displayID): \(display.frame)")
    }
}
```

## レーザー表示との統合

レーザーラインを表示する際：

1. **カーソル位置検出**：カーソルがどのディスプレイに含まれているかを判定
2. **座標系チェック**：物理キャリブレーションが存在するかチェック
3. **座標変換**：
   - キャリブレーションが存在する場合：論理座標から物理座標に変換
   - キャリブレーションがない場合：論理座標を直接使用
4. **レーザーレンダリング**：選択された座標系を使用してラインを描画

これにより、ディスプレイ配置の複雑さに関係なく、レーザーラインが常に正確に指すようになります。

## ベストプラクティス

### いつキャリブレーションすべきか

以下の場合にキャリブレーションを行います：
- LaserGuideを初めてセットアップするとき
- ディスプレイを追加または削除したとき
- ディスプレイの位置を物理的またはmacOS設定で再配置したとき
- レーザーラインがカーソルを正確に指さないとき

### キャリブレーションのヒント

1. **まずmacOS設定から**：論理配置を最初に設定
2. **現実に合わせる**：キャリブレーションは実際の机の上のセットアップを反映すべき
3. **ベゼルを考慮**：ディスプレイ間の物理的なギャップを考慮
4. **レーザーで検証**：キャリブレーション後、カーソルを動かして精度を検証
5. **必要に応じて再キャリブレーション**：いつでも調整して再保存可能

### 複数の場所

異なる場所（自宅、オフィスなど）でMacを使用する場合：
- 各場所のディスプレイ構成は独自のキャリブレーションを持つ
- LaserGuideは自動的に適切なキャリブレーションを検出してロード
- 手動での切り替えは不要

## 将来の機能拡張

キャリブレーションシステムの潜在的な改善：

- キャリブレーションデータのエクスポート/インポート
- デバイス間でのキャリブレーションのクラウド同期
- テストパターンを使ったガイド付きキャリブレーションウィザード
- カメラ/ARを使用した自動検出（野心的！）

## 関連項目

- [マルチディスプレイPPI補正](multi-display-ppi-correction.ja.md) - 元の問題の説明
- [スマートエッジナビゲーション](smart-edge-navigation.ja.md) - キャリブレーションデータを使用する機能
