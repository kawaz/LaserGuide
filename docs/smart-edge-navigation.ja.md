# スマートディスプレイエッジナビゲーション

## 概要

**スマートエッジナビゲーション**は、マルチモニターセットアップでのディスプレイ間のカーソル移動を改善する機能です。ディスプレイのエッジが直接接していない場合でも、カーソルを隣接するディスプレイに自動的にワープさせ、カーソルが引っかかる「デッドゾーン」を解消します。

## 問題：カーソルのデッドゾーン

### 典型的なシナリオ

2つのモニタが縦に並んでいる場合を想像してください：
- **上モニタ**：大型27インチ（2560×1440ピクセル）
- **下モニタ**：小型13インチ（2880×1800ピクセル）、中央配置

macOSのディスプレイ設定で、小さいモニタが大きいモニタの下に中央配置されています：

```
┌─────────────────────────────────────┐
│                                     │
│       上モニタ（大型）                 │
│                                     │
├─────┬───────────────────────┬───────┤
│ ◄─┐ │                       │ ┌─► │
│Dead│     下モニタ（小型）      │Dead │
│Zone│                       │Zone │
└─────┴───────────────────────┴─────┘
```

**問題点：**
- 上モニタの左下隅や右下隅にカーソルを移動して...
- ...さらに下に移動しようとすると...
- **カーソルが引っかかります！** それらの隅の下には直接ディスプレイが存在しません。

これにより、カーソルの移動が予期せず停止する「デッドゾーン」が発生します。

### 実際の影響

デッドゾーンは以下のような場合によく発生します：
- ディスプレイのサイズが異なる（ノートPC + 外部モニタ）
- 中央配置の縦積み
- 中央配置の横並び
- L字型またはコの字型のマルチモニタセットアップ
- エッジが完全に一致しない構成

## 解決策：スマートエッジワープ

スマートエッジナビゲーションは、デッドゾーンを通過しようとしていることを検出し、その方向にある最も近いディスプレイにカーソルを自動的にワープします。

### 仕組み

1. **エッジ検出**：カーソルが画面端（5ピクセル以内）に到達したことを監視
2. **意図認識**：ブロックされた方向への継続的な移動試行を検出
3. **スマート検索**：その方向にある最も近いディスプレイを見つける（直接隣接していなくても）
4. **自然なワープ**：ターゲットディスプレイのエッジ上の対応する位置にカーソルを移動
5. **物理的認識**：可能な場合はキャリブレーションデータを使用してより自然な遷移を実現

### 例の動作

積み重ねられたモニタの例を使用：

```
上モニタ：
  ユーザーが右下隅にカーソルを移動 → 下へ移動を続ける

スマートエッジナビゲーション：
  検出：エッジ + 下方向への意図
  発見：下モニタ（直下ではないが下方向に存在）
  ワープ：下モニタの右上にカーソル移動

結果：
  デッドゾーンがあってもスムーズに遷移！
```

## 技術的アプローチ

### 正確な検出のためのCGEventTap

スマートエッジナビゲーションは、低レベルでマウスイベントを監視するために `CGEventTap` を使用します：

**なぜCGEventTap？**
- 正確なマウス移動の差分（`deltaX`、`deltaY`）を提供
- 位置だけでなく移動の*方向*を検出
- 「エッジで休止」と「エッジで引っかかって更に移動しようとしている」を区別可能

**移動意図の検出：**
```swift
// 例：カーソルが下端にある
if cursorY == screenMaxY {  // エッジにいる
    if deltaY < 0 {          // まだ下に移動しようとしている（負のY）
        // ユーザーは更に進みたい → ワープをトリガー！
    }
}
```

### ディスプレイ検索戦略

ワープ時、システムは次の順序でターゲットディスプレイを検索します：

1. **論理的に隣接**：その方向に直接接しているディスプレイがあるか確認
2. **物理的近接性**：キャリブレーションデータが存在する場合、物理的に最も近いディスプレイを検索
3. **位置マッピング**：エッジに沿った相対位置を計算（0-100%）
4. **対応点**：ターゲットディスプレイのエッジ上の同じ相対位置にマップ

### 座標系

**キャリブレーションなし：**
- macOSの論理座標を使用
- ディスプレイフレームの境界に基づいて検索
- 論理的な寸法を使用してエッジ間をマップ

**キャリブレーションあり：**
- 物理座標（ミリメートル）を使用
- 実際の物理位置に基づいて検索
- 複雑なセットアップでより自然な遷移を提供

## ユーザー体験

### 有効化/無効化

- **デフォルト**：有効
- **切り替え**：メニューバー → **LaserGuide** > **Smart Edge Navigation**（チェックマーク）
- **永続化**：アプリ再起動後も設定が保存

### 権限要件

スマートエッジナビゲーションはCGEventTapを使用するため、**アクセシビリティ権限**が必要です。

**初回有効化時：**
1. macOSが権限プロンプトを表示
2. ユーザーが「システム設定を開く」をクリック
3. ユーザーがLaserGuideの権限を切り替え
4. 機能が自動的に有効化

**権限が拒否された場合：**
- 機能は非アクティブのまま
- メニュー項目に「（権限が必要）」と表示
- クリックすると再度権限のプロンプトが表示

### 動作の詳細

**ワープが発生する場合：**
- カーソルが画面端に到達（5px以内）
- ブロックされた方向への移動が50-100ms継続
- その方向にターゲットディスプレイが見つかった
- カーソルが瞬時にターゲット位置にワープ

**ワープが発生しない場合：**
- カーソルがエッジにあるが移動していない
- 移動がエッジに平行（外向きではない）
- その方向にディスプレイが存在しない
- 設定で機能が無効

**自然な感触：**
- 可能な場合は水平/垂直位置を保持
- スムーズな瞬間テレポート（アニメーション不要）
- macOSのディスプレイエッジ動作と一貫性

### システム互換性

**動作確認済み：**
- ホットコーナー - 干渉なし
- Dock自動非表示 - 干渉なし
- Mission Controlエッジジェスチャー - 干渉なし
- フルスクリーンアプリのエッジ表示 - 干渉なし

**なぜ競合しないのか？**
スマートエッジナビゲーションはデッドゾーン（隣接ディスプレイのないエッジ）でのみ動作します。ディスプレイが直接隣接している場合、通常のmacOSの動作が変更されずに継続します。

## マルチモニタ構成

### サポートされているレイアウト

**縦積み（サイズ違い）：**
```
┌─────────────┐
│    Large    │
├────┬───┬────┤
     │Sm │     ← 灰色ゾーンからワープ動作
     └───┘
```

**横並び（高さ違い）：**
```
┌───┐ ┌─────┐
│Sml│ │Large│
└───┘ └─────┘
  ↕           ← 灰色ゾーンからワープ動作
```

**L字型：**
```
┌───┬───┐
│ A │ B │
└───┴───┤
    │ C │    ← 直接接していなくてもB↔Cワープ
    └───┘
```

**コの字型：**
```
┌───┬───┬───┐
│ A │ B │ C │
└───┘   └───┘
  ↕  (gap) ↕  ← ギャップを通してA↔Cワープ
```

### 物理キャリブレーションあり

[物理レイアウトキャリブレーション](physical-layout-calibration.ja.md)が設定されている場合：

- 実際の物理位置を尊重してワープ
- 複雑なセットアップでより自然な遷移
- 回転や3D机配置を考慮
- ベゼル幅とギャップを正しく処理

**例：**
下モニタが物理的に右にオフセットされているが論理的には中央配置の場合、ワープは論理的な配置だけでなく物理的に正しい位置をターゲットにします。

## 実装ノート

### 独立モジュール

スマートエッジナビゲーションは独立したモジュールとして実装されています：
- レーザー表示機能を妨げない
- `CalibrationDataManager`経由でキャリブレーションデータのみを共有
- 独立して有効化/無効化可能
- 独自のCGEventTapを実行

### パフォーマンス

- **低オーバーヘッド**：カーソルがエッジ付近にあるときのみアクティブ
- **効率的な検出**：ハードウェアアクセラレーテッドイベントシステムを使用
- **ポーリングなし**：イベント駆動アーキテクチャ
- **瞬時ワープ**：アニメーション遅延なし

### 安全性

- **干渉なし**：通常のカーソル移動をブロックしない
- **可逆的**：不要な場合は簡単に無効化
- **設定可能**：異なる好みに対して閾値を調整可能
- **ログ記録**：トラブルシューティング用のデバッグ出力

## 将来の機能拡張

潜在的な改善：

- **エッジごとの設定**：特定のエッジを有効/無効化
- **調整可能な感度**：意図検出タイミングの調整
- **カスタムワープポイント**：ユーザー定義のワープ先
- **視覚的フィードバック**：ワープ発生時のオプションインジケータ
- **統計**：ワープの使用頻度を追跡

## FAQ

**Q: ホットコーナーに干渉しますか？**
A: いいえ。ホットコーナーはディスプレイが実際に接している隅でトリガーされます。スマートエッジナビゲーションはデッドゾーンでのみ動作します。

**Q: 物理キャリブレーションなしで使用できますか？**
A: はい！デフォルトで論理座標で動作します。キャリブレーションは複雑なセットアップでより正確にするだけです。

**Q: ワープ動作が気に入らない場合は？**
A: メニューで「Smart Edge Navigation」をオフに切り替えるだけです。設定は保持されます。

**Q: 追加の権限が必要ですか？**
A: はい、CGEventTapのアクセシビリティ権限が必要です。macOSが初回使用時にプロンプトを表示します。

**Q: バッテリーを消耗しますか？**
A: 大きな影響はありません。システムは継続的なポーリングではなく、効率的なイベント駆動監視を使用します。

**Q: 検出感度を調整できますか？**
A: UIではまだできませんが、実装は調整可能な定数を使用しています。将来のバージョンで設定として公開される可能性があります。

## 関連項目

- [物理レイアウトキャリブレーション](physical-layout-calibration.ja.md) - ワープ精度の向上
- [スマートエッジナビゲーション実装](smart-edge-navigation-implementation.md) - 技術詳細
