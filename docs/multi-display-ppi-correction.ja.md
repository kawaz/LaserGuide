# マルチディスプレイPPI補正

## 問題の概要

PPI（Pixels Per Inch、1インチあたりのピクセル数）が異なる複数のディスプレイを使用している場合、カーソルが存在しないディスプレイ上でレーザーラインの位置がズレて表示されます。

これは、macOSが論理座標系を使用しており、物理的なサイズが大きく異なるディスプレイでも同じような論理解像度を持つことができるためです。同じ論理的な距離が、物理的には大きく異なる距離を表すことになります。

## 実際の例

### ディスプレイ設定（実測値）

**ディスプレイ1: 内蔵ディスプレイ（MacBook）**
- 解像度: 3456 x 2234 ポイント
- 物理サイズ: 344mm x 222mm
- PPI: **255**
- リフレッシュレート: 120 Hz
- 位置: 原点 (0, 0)

**ディスプレイ2: LG ULTRAGEAR+**
- 解像度: 3440 x 1440 ポイント
- 物理サイズ: 1053mm x 441mm
- PPI: **83**
- リフレッシュレート: 240 Hz
- 位置: 原点 (0, 2234) - ディスプレイ1の上に配置

### ディスプレイの配置

```
┌─────────────────────────────────┐
│   LG ULTRAGEAR+ (3440x1440)     │ ← PPI: 83
│   物理サイズ: 1053mm x 441mm    │
└─────────────────────────────────┘
┌──────────────────────────────┐
│  内蔵 (3456x2234)            │ ← PPI: 255
│  物理サイズ: 344mm x 222mm   │
└──────────────────────────────┘
```

### 問題の詳細

両ディスプレイの論理的な幅はほぼ同じ（約3450ポイント）ですが、物理的なサイズは約3倍異なります：
- 内蔵ディスプレイ: 幅344mm
- LGディスプレイ: 幅1053mm（約3.06倍大きい）

これは以下を意味します：
- 内蔵ディスプレイでの1ポイント = 0.135mm (344mm / 3456 ポイント)
- LGディスプレイでの1ポイント = 0.306mm (1053mm / 3440 ポイント)

カーソルが一方のディスプレイにあり、レーザーラインがもう一方のディスプレイに描画される場合、同じ論理的な距離が異なる物理的な距離を表すため、角度が正しく表示されません。

## 補正方法

### アプローチ: PPIベースのスケーリング

ディスプレイ間で正しい物理的な角度を維持するには：

1. **カーソルが存在するディスプレイ**とそのPPIを特定
2. **レーザーラインを表示する各ディスプレイ**について補正係数を計算
3. **PPI比率に基づいてスケーリング**を適用

### 補正式

```
補正係数 = カーソル側ディスプレイPPI / レーザー表示側ディスプレイPPI
```

### 計算例

**ケース: カーソルが内蔵ディスプレイ、レーザーがLGディスプレイ**

```
補正係数 = 255 / 83 ≈ 3.07
```

LGディスプレイ上にレーザーラインを描画する際：
- 角からの計算距離を**3.07倍する**
- これによりLGディスプレイの低PPI（大きな物理ピクセル）を補正

**ケース: カーソルがLGディスプレイ、レーザーが内蔵ディスプレイ**

```
補正係数 = 83 / 255 ≈ 0.33
```

内蔵ディスプレイ上にレーザーラインを描画する際：
- 角からの計算距離を**0.33倍する**
- これにより内蔵ディスプレイの高PPI（小さな物理ピクセル）を補正

## 実装上の考慮事項

### ディスプレイごとに必要な情報

各`NSScreen`について：
1. 論理解像度 (`screen.frame.size`)
2. 物理サイズ (`CGDisplayScreenSize()`)
3. PPI計算: `ピクセル数 / (物理サイズ / 25.4)`
4. 座標系内での位置 (`screen.frame.origin`)

### 補正の適用

レーザーラインの終点を計算する際：

```swift
// 現在の実装（マルチディスプレイで不正確）
let endpoint = calculateLineEndpoint(from: corner, to: cursorPosition)

// 補正版の実装
let cursorScreen = getScreen(containing: cursorPosition)
let laserScreen = getScreen(containing: corner)
let correctionFactor = cursorScreen.ppi / laserScreen.ppi

let endpoint = calculateLineEndpoint(
    from: corner,
    to: cursorPosition,
    scaleFactor: correctionFactor
)
```

### エッジケース

1. **ディスプレイ境界上のカーソル**: カーソルの主ディスプレイを判定する必要がある
2. **3台以上のディスプレイ**: 各ディスプレイはカーソル側ディスプレイに対して独立した補正が必要
3. **ディスプレイミラーリング**: ミラーリング時は補正が不要な可能性
4. **回転**: 物理的な角度補正がより複雑になる

## 代替アプローチ

### 1. 物理座標系
すべての計算を論理ポイントではなく物理単位（mm）で行う。

**利点:**
- 数学的に純粋
- あらゆるディスプレイ設定に対応

**欠点:**
- 実装が複雑
- 浮動小数点精度の問題の可能性

### 2. ディスプレイごとのキャリブレーション
ユーザーが補正係数を手動で調整できるようにする。

**利点:**
- 視聴距離や個人の好みを考慮可能
- 自動検出が失敗した場合のシンプルなフォールバック

**欠点:**
- ユーザー設定が必要
- 自動ではない

## 推奨ソリューション

**PPIベースの自動補正**と手動キャリブレーションのオプション：
1. 各ディスプレイのPPIを自動計算
2. デフォルトでPPI比率補正を適用
3. ユーザー設定で補正係数を調整可能に（0.5倍〜2.0倍の範囲）

これにより：
- ✅ 一般的なケースでの自動補正
- ✅ エッジケースや好みに応じたユーザーオーバーライド
- ✅ シンプルな実装
- ✅ 保守しやすいコード

## 参考資料

- macOS座標系: https://developer.apple.com/documentation/appkit/nsscreen
- ディスプレイ情報: `CGDisplayScreenSize()`, `CGDisplayCopyDisplayMode()`
- PPI計算: pixels per inch = (ピクセル数) / (物理サイズ（インチ）)

## 座標系に関する設計判断

### 論理座標 vs 物理座標の問題

ディスプレイの物理的な配置と論理的な配置が異なる場合の懸念：

```
物理配置:
111111      (LG: 1053mm幅)
332233      (内蔵: 344mm幅が物理的には左右に分かれる)

論理配置の可能性:
111111      111111      111111      111111
332233       332233      332233       332233
(左揃え)    (中央揃え)  (右揃え)    (カスタム)
```

### 採用した解決策

**論理座標系を尊重し、ディスプレイ内でのPPI補正に焦点を当てる**

#### 理由:

1. **macOSの座標系を信頼**
   - システム環境設定の「配置」が論理座標系に反映される
   - ユーザーが設定した配置を尊重することが最も自然

2. **物理配置の推測を回避**
   - 論理座標から物理配置を完全に推測することは不可能
   - 誤った推測は逆に問題を引き起こす

3. **相対距離の補正に集中**
   - 絶対位置ではなく、相対的な距離のスケール補正が本質
   - カーソルと角の間の「物理的な角度」を正しく表現する

#### 実装方針:

```swift
// カーソル位置とレーザー表示位置が異なるディスプレイの場合のみ補正
let cursorScreen = getScreen(containing: cursorPosition)
let cornerScreen = getScreen(containing: corner)

if cursorScreen != cornerScreen {
    // 距離をPPIで補正
    let correctionFactor = cursorScreen.ppi / cornerScreen.ppi
    // 角からカーソルへの距離を補正係数で調整
}
```

#### メリット:

- ✅ システム環境設定の配置設定を尊重
- ✅ 物理的な配置の推測が不要
- ✅ ユーザー設定・キャリブレーション不要
- ✅ 実装がシンプルで保守しやすい
- ✅ 3台以上のディスプレイでも同じロジックで動作

#### 制約:

- 論理座標系での配置が物理的な配置と大きく異なる場合は完璧ではない
- ただし、ほとんどのユーザーは論理配置を物理配置に合わせて設定する

## 測定日

ディスプレイ情報測定日: 2025年10月7日

ディスプレイの追加、削除、再設定時には設定が変わる可能性があります。

## 設計判断履歴

- 2025-10-07: 初期問題分析とPPIベース補正方針の決定
- 2025-10-07: 座標系アプローチの決定（論理座標系を尊重、相対距離補正に集中）
