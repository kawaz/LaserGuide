# 設計ドキュメント

## 概要

LaserGuideアプリケーションにおいて、トレイアイコンをクリックした際にレーザー追跡が固定されてしまう問題を解決するための設計です。トレイアイコンはおまけ機能（現在はQuitのみ）ですが、これをクリックすることでメイン機能であるレーザー追跡に悪影響を与えてしまっています。

本設計では、トレイアイコンのイベント処理がマウス追跡に干渉しないよう、マウス追跡を独立したシステムとして動作させます。

## アーキテクチャ

### 現在の問題分析

1. **イベント処理の競合**: トレイアイコンクリック時に発生するシステムイベントがマウス追跡イベントを阻害
2. **イベントループの中断**: メニュー表示中にメインイベントループが一時停止または優先度が変更される
3. **フォーカス管理の問題**: トレイメニューがアクティブになることでアプリケーションのフォーカス状態が変化

### 解決アプローチ

1. **独立したマウス追跡スレッド**: メインUIスレッドとは別のスレッドでマウス追跡を実行
2. **グローバルマウスイベント監視**: システム全体のマウスイベントを監視し、アプリケーションフォーカスに依存しない追跡
3. **イベント優先度管理**: トレイ操作中もマウス追跡イベントの優先度を維持

## コンポーネントと インターフェース

### 1. MouseTrackingManager (新規)

```swift
class MouseTrackingManager: ObservableObject {
    // グローバルマウスイベント監視を管理
    // システムUIの状態に関係なく動作
    func startGlobalMouseTracking()
    func stopGlobalMouseTracking()
    func isTrackingActive() -> Bool
    func getCurrentMousePosition() -> CGPoint
    
    // 回復機能
    func detectTrackingFailure() -> Bool
    func forceRecoveryTracking()
    
    // イベント監視
    private var globalEventMonitor: Any?
    private var trackingQueue: DispatchQueue
}
```

**責任**:
- システム全体のマウス位置を監視（NSEvent.addGlobalMonitorForEvents使用）
- アプリケーションフォーカス状態に依存しない追跡
- トレイメニュー表示中も継続的な動作
- 追跡失敗の検出と自動回復（100ms以内）

### 2. AppDelegate (既存・修正)

**修正内容**:
- トレイアイコンのイベント処理方法の改善
- マウス追跡への影響を最小化するイベントハンドリング

### 3. LaserViewModel (既存・拡張)

**拡張内容**:
- MouseTrackingManagerとの連携
- グローバルマウス追跡の統合

## データモデル

### MouseTrackingConfiguration

```swift
struct MouseTrackingConfiguration {
    let useGlobalTracking: Bool = true
    let trackingPriority: DispatchQoS = .userInteractive
}
```

## エラーハンドリング

### システムイベント競合

- グローバルマウスイベントの優先度設定
- トレイメニューイベントとの協調処理
- イベントループの独立性確保

## テスト戦略

### 1. 単体テスト

- MouseTrackingManagerの独立動作テスト
- グローバルマウス追跡の動作テスト
- イベント競合時の動作テスト

### 2. 統合テスト

- トレイメニュー操作中のマウス追跡継続テスト
- 複数システムUIとの相互作用テスト
- 長時間動作での安定性テスト

### 3. ユーザーシナリオテスト

- トレイアイコンクリック→メニュー表示→マウス移動のシーケンス
- 他アプリトレイメニューとの相互作用
- システム負荷時の動作確認

## 実装上の考慮事項

### 1. パフォーマンス

- グローバルマウス追跡のCPU使用量最適化
- 不要なイベント処理の削減
- メモリリークの防止

### 2. セキュリティ

- システム全体のマウスイベント監視に必要な権限
- プライバシー設定との適合性
- サンドボックス制限への対応

### 3. 互換性

- macOSバージョン間の動作保証
- 他のマウス関連アプリケーションとの競合回避
- アクセシビリティ機能との協調

## 設計決定の根拠

### 1. 独立したマウス追跡スレッドの採用

**理由**: メインUIスレッドがトレイメニュー処理で占有されても、マウス追跡が継続できる

**代替案**: メインスレッドでの優先度調整
**却下理由**: システムUIイベントの優先度制御が困難

### 2. グローバルマウスイベント監視の使用

**理由**: アプリケーションフォーカス状態に依存しない確実な追跡

**代替案**: アプリケーション内イベントのみ使用
**却下理由**: トレイメニュー表示中はアプリケーションフォーカスが変化する

### 3. シンプルなアーキテクチャの採用

**理由**: 複雑な状態管理や復旧機能を避け、根本的な解決に集中

**根拠**: トレイメニューは基本的に使用されないため、過度な複雑化は不要